services:
  bot:
    build: .
    env_file:
      - .env
      - ./secrets/.docker-env
    environment:
      - VAULT_PATH=/app/vault
      - HOME=/home/botuser
      # Stage 6: Code Agent â€” host paths for Docker-in-Docker volume mapping
      - WORKSPACE_HOST_PATH=${WORKSPACE_HOST_PATH:-${PWD}/workspace}
      - DATA_HOST_PATH=${DATA_HOST_PATH:-${PWD}/data}
      - CLAUDE_CONFIG_HOST_PATH=${CLAUDE_CONFIG_HOST_PATH:-${HOME}/.claude}
      - PROJECT_HOST_PATH=${PROJECT_HOST_PATH:-${PWD}}
    # Stage 6: Docker socket group (run `stat -c '%g' /var/run/docker.sock` on host)
    group_add:
      - "${DOCKER_GID:-0}"
    read_only: true
    cap_drop: [ALL]
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:size=100M,noexec,nosuid
      - /home/botuser:size=50M,mode=0700,uid=1001,gid=1001
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - ./data:/app/data
      - ./workspace:/app/workspace
      # Stage 3: Obsidian vault. Set VAULT_PATH in .env
      - ${VAULT_PATH:-/dev/null}:/app/vault
      # Stage 6: Docker socket for Code Agent sandbox management
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    stop_grace_period: 20s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
